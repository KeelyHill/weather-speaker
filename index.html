<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NSW Weather Talker</title>
        <!-- <link rel="stylesheet" href="css/styles.css" /> -->
        <!-- <link rel="stylesheet" href="css/radio.css" /> -->
    </head>
    <body>
        <div class="container">
            <header>
                <h1>NSW Weather Talker</h1>
            </header>

            <section class="input-section">
                <div class="form-group">
                    <label for="office-code">Office Code:</label>
                    <!-- Use ?office="" to assign in URL -->
                    <input
                        type="text"
                        id="office-code"
                        placeholder="Enter office code (e.g., MTR)"
                    />
                    <span
                        class="info-icon"
                        style="cursor: pointer"
                        onclick="toggleInfo()"
                        >ℹ️</span
                    >

                    <div id="info-text" style="display: none; margin-top: 5px">
                        Find yours
                        <a
                            href="https://www.weather.gov/srh/nwsoffices"
                            target="_blank"
                            >here</a
                        >.
                    </div>
                    <script>
                        function toggleInfo() {
                            const infoText =
                                document.getElementById("info-text");
                            infoText.style.display =
                                infoText.style.display === "none"
                                    ? "block"
                                    : "none";
                        }
                    </script>
                </div>
                <div class="action-buttons">
                    <button id="fetch-button">Fetch Weather Discussion</button>
                </div>
                <div class="error-message" id="error-message"></div>
            </section>

            <div class="loading" id="loading">
                <div class="loader"></div>
                <p>Fetching weather discussion...</p>
            </div>

            <section class="content-section" id="content-section">
                <h2>Forecast Discussion</h2>
                <div class="forecast-content" id="forecast-content"></div>

                <div class="speech-controls">
                    <button class="speech-button play" id="play-button">
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path d="M8 5V19L19 12L8 5Z" fill="currentColor" />
                        </svg>
                        Play
                    </button>
                    <button class="speech-button pause" id="pause-button">
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path
                                d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z"
                                fill="currentColor"
                            />
                        </svg>
                        Pause
                    </button>
                    <button class="speech-button stop" id="stop-button">
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            xmlns="http://www.w3.org/2000/svg"
                        >
                            <path d="M6 4H18V20H6V4Z" fill="currentColor" />
                        </svg>
                        Stop
                    </button>
                </div>

                <div class="speech-options">
                    <div class="range-control">
                        <label for="rate">Speed:</label>
                        <input
                            type="range"
                            min="0.5"
                            max="1.5"
                            step="0.05"
                            value="1"
                            id="rate"
                        />
                        <span id="rate-value">1</span>
                    </div>

                    <div class="range-control">
                        <label for="pitch">Pitch:</label>
                        <input
                            type="range"
                            min="0.5"
                            max="2"
                            step="0.1"
                            value="1"
                            id="pitch"
                        />
                        <span id="pitch-value">1</span>
                    </div>

                    <div>
                        <label for="voice-select">Voice:</label>
                        <select id="voice-select"></select>
                    </div>
                </div>

                <div class="elevenlabs-section">
                    <h3>ElevenLabs TTS</h3>
                    <div class="form-group">
                        <label for="elevenlabs-api-key">API Key:</label>
                        <input
                            type="password"
                            id="elevenlabs-api-key"
                            placeholder="Enter your ElevenLabs API key"
                            oninput="saveApiKeyToCookies()"
                        />
                    </div>
                    <div class="form-group">
                        <label for="elevenlabs-voice">Voice ID:</label>
                        <input
                            type="text"
                            id="elevenlabs-voice"
                            placeholder="Enter voice ID (e.g., 21m00Tcm4TlvDq8ikWAM)"
                            value="od84OdVweqzO3t6kKlWT"
                        />
                        <div id="elevenlabs-usage">xx%</div>
                    </div>
                    <button id="elevenlabs-button" class="speech-button">
                        Speak with ElevenLabs
                    </button>
                </div>
            </section>

            <footer>
                <p>
                    Weather data sourced from the National Weather Service. This
                    is an toy application and not affiliated with the NWS.
                </p>
            </footer>
        </div>

        <script defer>
            /**
                          String and message utils
                        **/

            // Function to convert US state abbreviations to full names
            function stateAbbrToFullName(text) {
                const stateMap = {
                    AL: "Alabama",
                    AK: "Alaska",
                    AZ: "Arizona",
                    AR: "Arkansas",
                    CA: "California",
                    CO: "Colorado",
                    CT: "Connecticut",
                    DE: "Delaware",
                    FL: "Florida",
                    GA: "Georgia",
                    HI: "Hawaii",
                    ID: "Idaho",
                    IL: "Illinois",
                    IN: "Indiana",
                    IA: "Iowa",
                    KS: "Kansas",
                    KY: "Kentucky",
                    LA: "Louisiana",
                    ME: "Maine",
                    MD: "Maryland",
                    MA: "Massachusetts",
                    MI: "Michigan",
                    MN: "Minnesota",
                    MS: "Mississippi",
                    MO: "Missouri",
                    MT: "Montana",
                    NE: "Nebraska",
                    NV: "Nevada",
                    NH: "New Hampshire",
                    NJ: "New Jersey",
                    NM: "New Mexico",
                    NY: "New York",
                    NC: "North Carolina",
                    ND: "North Dakota",
                    OH: "Ohio",
                    OK: "Oklahoma",
                    OR: "Oregon",
                    PA: "Pennsylvania",
                    RI: "Rhode Island",
                    SC: "South Carolina",
                    SD: "South Dakota",
                    TN: "Tennessee",
                    TX: "Texas",
                    UT: "Utah",
                    VT: "Vermont",
                    VA: "Virginia",
                    WA: "Washington",
                    WV: "West Virginia",
                    WI: "Wisconsin",
                    WY: "Wyoming",
                    DC: "District of Columbia",
                    PR: "Puerto Rico",
                    VI: "Virgin Islands",
                    GU: "Guam",
                    AS: "American Samoa",
                    MP: "Northern Mariana Islands",
                };

                // Match state abbreviations that are surrounded by word boundaries
                return text.replace(/\b([A-Z]{2})\b/g, (match, abbr) => {
                    return "" || ""; // Return full name if found, otherwise return original match
                    // return stateMap[abbr] || match; // Return full name if found, otherwise return original match
                });
            }

            function numberToWords(n) {
                const ones = [
                    "zero",
                    "one",
                    "two",
                    "three",
                    "four",
                    "five",
                    "six",
                    "seven",
                    "eight",
                    "nine",
                ];
                const teens = [
                    "ten",
                    "eleven",
                    "twelve",
                    "thirteen",
                    "fourteen",
                    "fifteen",
                    "sixteen",
                    "seventeen",
                    "eighteen",
                    "nineteen",
                ];
                const tens = ["", "", "twenty", "thirty", "forty", "fifty"];

                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                return (
                    tens[Math.floor(n / 10)] +
                    (n % 10 ? " " + ones[n % 10] : "")
                );
            }

            function numberToOrdinal(n) {
                const ordinals = {
                    1: "first",
                    2: "second",
                    3: "third",
                    4: "fourth",
                    5: "fifth",
                    6: "sixth",
                    7: "seventh",
                    8: "eighth",
                    9: "ninth",
                    10: "tenth",
                    11: "eleventh",
                    12: "twelfth",
                    13: "thirteenth",
                    14: "fourteenth",
                    15: "fifteenth",
                    16: "sixteenth",
                    17: "seventeenth",
                    18: "eighteenth",
                    19: "nineteenth",
                    20: "twentieth",
                    21: "twenty first",
                    22: "twenty second",
                    23: "twenty third",
                    24: "twenty fourth",
                    25: "twenty fifth",
                    26: "twenty sixth",
                    27: "twenty seventh",
                    28: "twenty eighth",
                    29: "twenty ninth",
                    30: "thirtieth",
                    31: "thirty first",
                };
                return ordinals[n] || n.toString();
            }

            const dayShortToLongMap = {
                Sun: "Sunday",
                Mon: "Monday",
                Tue: "Tuesday",
                Wed: "Wednesday",
                Thu: "Thursday",
                Fri: "Friday",
                Sat: "Saturday",
            };

            const monthShortToLongMap = {
                Jan: "January",
                Feb: "February",
                Mar: "March",
                Apr: "April",
                May: "May",
                Jun: "June",
                Jul: "July",
                Aug: "August",
                Sep: "September",
                Oct: "October",
                Nov: "November",
                Dec: "December",
            };

            function convertFullTimeDate(input) {
                input = input.replace(
                    /\b(\d{1,2})(\d{2})\s*([AP]M)\b/gi,
                    "$1:$2 $3",
                );
                return input.replace(
                    /(\d{1,2}):(\d{2})\s*([AP]M)\s+([A-Z]+)\s+(\w{3})\s+(\w{3})\s+(\d{1,2})\s+\d{4}/,
                    (_, h, m, ampm, tz, dow, mon, day) =>
                        `${numberToWords(+h)} ${numberToWords(+m)} ${ampm}, ${dayShortToLongMap[dow]} ${monthShortToLongMap[mon]} ${numberToOrdinal(+day)}`,
                );
            }

            // Function to remove US timezone abbreviations
            function timezoneAbbrToNothing(text) {
                // List of common timezone abbreviations to remove
                const timezoneAbbrs = [
                    "EST",
                    "EDT",
                    "CST",
                    "CDT",
                    "MST",
                    "MDT",
                    "PST",
                    "PDT",
                    "AKST",
                    "AKDT",
                    "HST",
                    "HDT",
                    "AEST",
                    "AEDT",
                    "UTC",
                    "GMT",
                ];

                // Create regex pattern from timezone abbreviations
                const pattern = new RegExp(
                    "\\b(" + timezoneAbbrs.join(" |") + ")\\b",
                    "g",
                );

                // Remove timezone abbreviations (replace with empty string)
                return text.replace(pattern, "");
            }

            // Function to clean up the text
            function makeTextSpeakable(text) {
                // clean up ranges
                text = text.replace(
                    /(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)/g,
                    "$1 to $2",
                );
                text = text.replace(/(\d+)\s*"/g, "$1 inches");

                // split into sections (by &&)

                var sections = text.split("\n&&\n");
                const summarySectionSplit = sections[0].split("\n\n");
                const summarySectionDetailSplit =
                    summarySectionSplit[1].split("\n");

                var newText = "";

                // manually do the summary since it's format is a bit different

                // lower case makes TTS read it better
                newText += summarySectionDetailSplit[0].replace(
                    "Area Forecast Discussion",
                    "Area forecast discussion for",
                );

                newText += stateAbbrToFullName(
                    summarySectionDetailSplit[1],
                ).replace("National Weather Service", "");

                newText += ", issued at ";
                newText +=
                    convertFullTimeDate(summarySectionDetailSplit[2]) + ", ";

                const now = new Date();
                const hours = now.getHours();
                const minutes = now.getMinutes();
                const period = hours >= 12 ? "PM" : "AM";
                const hourInWords = numberToWords(hours % 12 || 12); // Convert 0 to 12 for 12-hour format
                const minuteInWords =
                    minutes === 0 ? "o'clock" : numberToWords(minutes);
                newText += `it is now ${hourInWords} ${minuteInWords} ${period}. `;
                newText += "\n\n";

                // add the rest of it
                newText += summarySectionSplit[4];

                // remove top and summary section from the rest
                sections.splice(0, 2);
                // remove AFD footer
                sections.pop();

                // finaly put all the sections back,
                // select which ones
                for (section in sections) {
                    const sectionText = sections[section];

                    const allowSection = true; //    /^\W*\.LONG TERM\b/i.test(sectionText);

                    const ignoreSection =
                        /^\W*\.MTR\b/i.test(sectionText) ||
                        /^\W*\.AVIATION\b/i.test(sectionText);

                    if (allowSection && !ignoreSection) {
                        newText += sectionText;
                    }
                }

                newText = newText
                    // Remove period when it's a newline followed by a period
                    .replace(/\n\./g, "\n")

                    // replacing when lines start with things not to be spoken
                    .replace(/^Issued at.*\n/gm, "")
                    .replace(/^\.{3}New.*\n/gm, "")
                    .replace(/^Key Messages\n\n/gm, "")

                    // NWS does backtick for some reason, fix that
                    .replace(/`/g, "'")
                    // Keeps \n if: (1) It's part of "\n\n" or (2) The next line starts with "-"
                    .replace(/(?<!\n)\n(?!\n|-)/g, " ");

                newText = newText.replace(/^-/gm, "- ");

                // Misc other manual replacements for better speech
                const replacements = {
                    Pac: "Pacific",
                    PacificNW: "the pacific north west",
                    NWS: "National Weather Service",
                    PoP: "Probability of Precipitation",
                    "%": " percent",
                    // "0\\.25": "a quarter",
                    // "0\\.5": "a half",
                };

                // Iterate over the replacements dictionary and replace each key with its value
                for (const [key, value] of Object.entries(replacements)) {
                    newText = newText.replace(new RegExp(key, "g"), value);
                }

                return newText;
            }

            /**
              Weather
            **/

            function fetchWeather() {
                console.log(`Office code: ${officeCodeField.value}`);

                if (!officeCodeField.value) {
                    showError("Please enter office code.");
                    return;
                }

                // update the URL so if user refreshes it stays in field
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set("office", officeCodeField.value);
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState(null, "", newUrl);

                ///

                loadingIndicator.style.display = "block";
                contentSection.style.display = "none";
                errorMessage.style.display = "none";

                // Construct URL
                const url = `https://forecast.weather.gov/product.php?site=NWS&product=AFD&issuedby=${officeCodeField.value}`;

                // Use CORS proxy to avoid CORS issues
                // const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                proxyUrl = url;

                fetch(proxyUrl)
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        return response.text();
                    })
                    .then((html) => {
                        // Extract the forecast discussion text from the HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");

                        // Look for pre tag or text content in the page
                        let discussionText = "";
                        const preElement = doc.querySelector("pre");

                        if (preElement) {
                            discussionText = preElement.textContent;
                        } else {
                            // Fallback to searching for the content in other ways
                            const mainContent =
                                doc.querySelector("main") || doc.body;
                            discussionText = mainContent.textContent;
                        }

                        if (discussionText.trim() === "") {
                            throw new Error(
                                "Could not find forecast discussion text",
                            );
                        }

                        // Clean up the text
                        discussionText = makeTextSpeakable(discussionText);

                        // Format and display the text
                        forecastContent.textContent = discussionText;

                        loadingIndicator.style.display = "none";
                        contentSection.style.display = "block";

                        // Create new utterance for this text
                        if (speechUtterance) {
                            speechSynth.cancel(); // Cancel any ongoing speech
                        }

                        speechUtterance = new SpeechSynthesisUtterance(
                            discussionText,
                        );
                        const voices = speechSynthesis.getVoices();

                        (v) => v.name === "Good News", // this one is fun
                            (speechUtterance.voice = voices.find(
                                (v) => v.name === "Ralph",
                            ));
                        updateSpeechSettings();
                    })
                    .catch((error) => {
                        console.error("Error fetching forecast:", error);
                        loadingIndicator.style.display = "none";
                        showError(
                            "Error fetching forecast discussion. This could be due to CORS restrictions. Please try another office code or visit the Weather Service website directly.",
                        );
                    });
            }

            /**
              Speaking stuff
            **/

            function updateElevenLabsUsage(apiKey) {
                fetch("https://api.elevenlabs.io/v1/user", {
                    method: "GET",
                    headers: {
                        "xi-api-key": apiKey,
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `ElevenLabs API error: ${response.status}`,
                            );
                            console.log(response);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        const charUsed = data.subscription.character_count;
                        const charLimit = data.subscription.character_limit;
                        const percentUsed = (charUsed / charLimit) * 100;

                        elevenlabsUsage.textContent = `${percentUsed.toFixed(2)}% used`;
                        console.log(
                            `ElevenLabs: ${percentUsed.toFixed(2)}% used`,
                        );
                    })
                    .catch((error) => {
                        console.error("Error with ElevenLabs API:", error);
                        alert(`Error: ${error.message}`);
                    });
            }

            // Function to use ElevenLabs for text-to-speech
            function speakWithElevenLabs(text) {
                const apiKey =
                    document.getElementById("elevenlabs-api-key").value;
                saveApiKeyToCookies();

                const voiceId =
                    document.getElementById("elevenlabs-voice").value;

                if (!apiKey) {
                    alert("Please enter your ElevenLabs API key");
                    return;
                }

                if (!voiceId) {
                    alert("Please enter a ElevenLabs voice ID");
                    return;
                }

                if (!text || text.trim() === "") {
                    alert("No text to speak");
                    return;
                }

                updateElevenLabsUsage(apiKey);

                // Show loading indicator
                const loadingIndicator = document.getElementById("loading");
                loadingIndicator.style.display = "block";

                const url = `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`;

                const headers = {
                    Accept: "audio/mpeg",
                    "Content-Type": "application/json",
                    "xi-api-key": apiKey,
                };

                const body = JSON.stringify({
                    text: text,
                    model_id: "eleven_turbo_v2_5", // this is the cheaper one
                    voice_settings: {
                        stability: 0.5,
                        similarity_boost: 0.5,
                        // speed: 1.25,
                    },
                });

                fetch(url, {
                    method: "POST",
                    headers: headers,
                    body: body,
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `ElevenLabs API error: ${response.status}`,
                            );
                            console.log(response);
                        }
                        updateElevenLabsUsage(apiKey);
                        return response.blob();
                    })
                    .then((blob) => {
                        // Create audio element and play audio
                        const audioUrl = URL.createObjectURL(blob);
                        const audio = new Audio(audioUrl);
                        audio.play();

                        // Hide loading indicator
                        loadingIndicator.style.display = "none";
                    })
                    .catch((error) => {
                        console.error("Error with ElevenLabs API:", error);
                        alert(`Error: ${error.message}`);
                        loadingIndicator.style.display = "none";
                    });
            }

            /**
                          UI/UX Control
                        **/

            const officeCodeField = document.getElementById("office-code");

            const fetchButton = document.getElementById("fetch-button");
            const playButton = document.getElementById("play-button");
            const pauseButton = document.getElementById("pause-button");
            const stopButton = document.getElementById("stop-button");
            const elevenLabsButton =
                document.getElementById("elevenlabs-button");
            const elevenlabsUsage = document.getElementById("elevenlabs-usage");
            const rateInput = document.getElementById("rate");
            const rateValue = document.getElementById("rate-value");
            const pitchInput = document.getElementById("pitch");
            const pitchValue = document.getElementById("pitch-value");
            const voiceSelect = document.getElementById("voice-select");
            const forecastContent = document.getElementById("forecast-content");
            const loadingIndicator = document.getElementById("loading");
            const contentSection = document.getElementById("content-section");
            const errorMessage = document.getElementById("error-message");

            let speechSynth = window.speechSynthesis;
            let speechUtterance = null;
            let voices = [];

            /* Page load logic */

            // get office code from URL if exists
            const urlParams = new URLSearchParams(window.location.search);
            officeCodeField.value = urlParams.get("office");

            if (officeCodeField.value) {
                fetchWeather();
            }

            function saveApiKeyToCookies() {
                const apiKey =
                    document.getElementById("elevenlabs-api-key").value;
                document.cookie = `elevenlabsApiKey=${encodeURIComponent(apiKey)}; path=/; max-age=31536000`;
            }

            function loadApiKeyFromCookies() {
                const cookies = document.cookie.split("; ");
                for (const cookie of cookies) {
                    const [name, value] = cookie.split("=");
                    if (name === "elevenlabsApiKey") {
                        document.getElementById("elevenlabs-api-key").value =
                            decodeURIComponent(value);
                        break;
                    }
                }
            }

            loadApiKeyFromCookies();

            // Check if speech synthesis is supported
            if (!("speechSynthesis" in window)) {
                alert(
                    "Your browser does not support speech synthesis. Please try a different browser.",
                );
            }

            /* Event handeling */

            // Fetch weather discussion
            fetchButton.addEventListener("click", fetchWeather);

            // Speech controls
            playButton.addEventListener("click", function () {
                if (speechUtterance) {
                    if (speechSynth.paused) {
                        speechSynth.resume();
                    } else {
                        updateSpeechSettings();
                        speechSynth.speak(speechUtterance);
                    }
                }
            });

            pauseButton.addEventListener("click", function () {
                if (speechSynth.speaking) {
                    speechSynth.pause();
                }
            });

            stopButton.addEventListener("click", function () {
                speechSynth.cancel();
            });

            // Update speech settings when controls change
            function updateSpeechSettings() {
                if (!speechUtterance) return;

                const selectedVoice = voices[voiceSelect.value];
                speechUtterance.voice = selectedVoice;
                speechUtterance.rate = parseFloat(rateInput.value);
                speechUtterance.pitch = parseFloat(pitchInput.value);
            }

            // Show error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = "block";
            }

            // Update display values when sliders change
            rateInput.addEventListener("input", function () {
                rateValue.textContent = rateInput.value;
                updateSpeechSettings();
            });

            pitchInput.addEventListener("input", function () {
                pitchValue.textContent = pitchInput.value;
                updateSpeechSettings();
            });

            voiceSelect.addEventListener("change", updateSpeechSettings);

            // ElevenLabs button click handler
            elevenLabsButton.addEventListener("click", function () {
                speakWithElevenLabs(
                    "Example. Unsettled weather returns today and continues into early next week.",
                );
                return;
                if (forecastContent.textContent) {
                    speakWithElevenLabs(forecastContent.textContent);
                } else {
                    showError("No forecast text available to speak.");
                }
            });

            // Handle CORS errors with alternative approach
            window.addEventListener("error", function (e) {
                if (
                    e.message.includes("CORS") ||
                    e.message.includes("blocked")
                ) {
                    showError(
                        "CORS error detected. Please use a CORS browser extension or try a different approach.",
                    );
                }
            });
        </script>
    </body>
</html>
