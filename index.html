<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>NSW Weather Talker</title>
        <!-- <link rel="stylesheet" href="css/styles.css" /> -->
        <link rel="stylesheet" href="css/radio.css" />
    </head>
    <body>
        <div class="radio-case">
            <div class="radio">
                <div class="antenna"></div>

                <div class="radio-top">
                    <div>
                        <!-- <div class="dial-label">Tune in</div> -->
                        <div
                            class="media-buttons"
                            title="Fetch Weather Forcast"
                        >
                            <button class="media-btn" id="fetch-button">
                                Tune in
                            </button>

                            <div
                                id="tune-in-bulb"
                                class="bulb"
                                style="margin: auto 0"
                                title="Tune in (forcast text) status"
                            ></div>
                        </div>
                    </div>
                    <div class="radio-screen">
                        <div class="needle" id="needle"></div>

                        <label for="office-code">
                            <a
                                href="https://upload.wikimedia.org/wikipedia/commons/0/05/NWS_Weather_Forecast_Offices.svg"
                                target="_blank"
                                style="cursor: help"
                            >
                                Office:
                            </a>
                        </label>

                        <input type="text" id="office-code" placeholder="MTR" />
                    </div>
                </div>

                <div class="radio-controls">
                    <div class="toggle-switch">
                        <div class="label-text">Classic<br />Voice</div>
                        <input type="checkbox" id="voice-switch" />
                        <label for="voice-switch" class="switch-label">
                            <span class="slider"></span>
                        </label>
                        <div class="label-text">Natural<br />Voice</div>
                        <div
                            id="eleven-labs-status-bulb"
                            class="bulb"
                            title="Connection to ElevenLabs"
                        ></div>
                    </div>

                    <div class="media-buttons">
                        <button
                            class="media-btn media-btn-square"
                            id="play-button"
                        >
                            <!-- ▶ -->
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M8 5V19L19 12L8 5Z"
                                    fill="currentColor"
                                />
                            </svg>
                        </button>

                        <button
                            class="media-btn media-btn-square"
                            id="pause-button"
                        >
                            <svg
                                viewBox="0 0 24 24"
                                fill="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <path
                                    d="M6 4H10V20H6V4ZM14 4H18V20H14V4Z"
                                    fill="currentColor"
                                />
                            </svg>
                        </button>
                        <button
                            class="media-btn media-btn-square"
                            id="stop-button"
                        >
                            <svg
                                viewBox="0 0 100 100"
                                xmlns="http://www.w3.org/2000/svg"
                                fill="currentColor"
                            >
                                <rect x="20" y="20" width="60" height="60" />
                            </svg>
                        </button>
                    </div>

                    <!-- <div class="tuning-dial">
                    <div class="dial-label">Tuning</div>
                    <div class="dial-knob" id="tuningKnob"></div>
                    </div> -->
                </div>

                <div class="radio-middle">
                    <!-- Extra div here to have a vertical stack next to speaker -->
                    <div style="margin: 20px 0px">
                        <div
                            id="bulb-todo"
                            class="bulb"
                            title="TODO TODO TODO"
                        ></div>
                    </div>

                    <div class="radio-speaker">
                        <div
                            style="
                                font-family: Monoton, sans-serif;
                                font-size: 0.8rem;
                                color: #ccc;
                                text-shadow: 0 4px 2px black;
                            "
                        >
                            = = =
                        </div>
                    </div>
                </div>

                <div
                    style="
                        font-family:
                            Fascinate Inline,
                            sans-serif;
                        font-size: 3.5rem;
                        color: #ccc;
                        text-shadow: 0 4px 1px black;
                        position: absolute;
                        margin-left: 15px;
                        bottom: 0;
                        left: 0;
                    "
                >
                    NOAA
                </div>
                <div
                    style="
                        font-family:
                            Fascinate Inline,
                            sans-serif;
                        font-size: 3.5rem;
                        color: #ccc;
                        text-shadow: 0 4px 1px black;
                        position: absolute;
                        margin-right: 15px;
                        bottom: 0;
                        right: 0;
                    "
                >
                    NWS
                </div>
                <div
                    style="
                        font-family: Monoton, sans-serif;
                        font-size: 1rem;
                        color: #ccc;
                        text-shadow: 0 4px 2px black;
                        position: absolute;
                        margin-bottom: 5px;
                        bottom: 0;
                        left: 50%;
                        transform: translateX(-50%);
                    "
                >
                    <!-- weather.gov -->
                </div>
            </div>
        </div>

        <div class="radio-platform"></div>

        <div
            class="error-message-box"
            id="error-message-box"
            style="display: none"
        >
            Placeholder Error Message
        </div>

        <hr />

        <div class="container">
            <div class="loading" id="loading">
                <div class="loader"></div>
                <p>Fetching weather discussion...</p>
            </div>

            <section>
                <div class="elevenlabs-section">
                    <h3>ElevenLabs Text to Speech</h3>
                    <div class="form-group">
                        <label for="elevenlabs-api-key">API Key:</label>
                        <input
                            type="password"
                            id="elevenlabs-api-key"
                            placeholder="Enter your ElevenLabs API key"
                            oninput="saveApiKeyToCookies()"
                        />
                    </div>
                    <div class="form-group">
                        <label for="elevenlabs-voice">Voice ID:</label>
                        <input
                            type="text"
                            id="elevenlabs-voice"
                            placeholder="Enter voice ID (e.g., 21m00Tcm4TlvDq8ikWAM)"
                            value="od84OdVweqzO3t6kKlWT"
                            oninput="saveVoiceIdToCookies()"
                        />
                        <div id="elevenlabs-usage">xx%</div>
                    </div>
                </div>
            </section>

            <hr />

            <h2>Text Processing</h2>

            <div style="margin-bottom: 20px">
                <h3>Ignore Sections:</h3>
                <div
                    style="
                        display: flex;
                        flex-wrap: wrap;
                        gap: 15px;
                        margin: 10px 0;
                    "
                >
                    <label style="display: flex; align-items: center; gap: 5px">
                        <input type="checkbox" id="ignore-short-term" />
                        <span>SHORT TERM</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px">
                        <input type="checkbox" id="ignore-long-term" />
                        <span>LONG TERM</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px">
                        <input type="checkbox" id="ignore-marine" />
                        <span>MARINE</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px">
                        <input type="checkbox" id="ignore-aviation" checked />
                        <span>AVIATION</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px">
                        <input type="checkbox" id="ignore-mtr" checked />
                        <span>MTR</span>
                    </label>
                </div>
            </div>

            <div class="text-section">
                <div
                    class="raw-forecast-content preformat"
                    id="raw-forecast-content"
                ></div>
                <div style="font-size: 40px; align-items: center">→</div>
                <div
                    class="forecast-content preformat"
                    id="forecast-content"
                ></div>
            </div>

            <hr />

            <footer>
                <p>
                    "Weather Talker", by
                    <a href="https://keelyhill.com">Keely Hill</a>
                    <br />
                    <br />
                    Weather data sourced from the National Weather Service.
                    <br />
                    This is an toy application and not affiliated with the NWS
                    or NOAA.
                </p>
            </footer>
        </div>

        <script defer>
            var glob_users_name = "";
            const officeCodeField = document.getElementById("office-code");

            const fetchButton = document.getElementById("fetch-button");
            const playButton = document.getElementById("play-button");
            const pauseButton = document.getElementById("pause-button");
            const stopButton = document.getElementById("stop-button");

            const needle = document.getElementById("needle");

            const elevenLabsBulb = document.getElementById(
                "eleven-labs-status-bulb",
            );

            const tuneInBulb = document.getElementById("tune-in-bulb");

            const voiceSwitch = document.getElementById("voice-switch");

            const elevenlabsUsage = document.getElementById("elevenlabs-usage");
            const voiceSelect = document.getElementById("voice-select");
            const forecastContent = document.getElementById("forecast-content");
            const rawForecastContent = document.getElementById(
                "raw-forecast-content",
            );
            const loadingIndicator = document.getElementById("loading");
            const errorMessageBox =
                document.getElementById("error-message-box");

            let speechSynth = window.speechSynthesis;
            let speechUtterance = null;

            var globalAudio = null;

            /**
            String and message utils
            **/

            // Function to convert US state abbreviations to full names
            function stateAbbrToFullName(text) {
                const stateMap = {
                    AL: "Alabama",
                    AK: "Alaska",
                    AZ: "Arizona",
                    AR: "Arkansas",
                    CA: "California",
                    CO: "Colorado",
                    CT: "Connecticut",
                    DE: "Delaware",
                    FL: "Florida",
                    GA: "Georgia",
                    HI: "Hawaii",
                    ID: "Idaho",
                    IL: "Illinois",
                    IN: "Indiana",
                    IA: "Iowa",
                    KS: "Kansas",
                    KY: "Kentucky",
                    LA: "Louisiana",
                    ME: "Maine",
                    MD: "Maryland",
                    MA: "Massachusetts",
                    MI: "Michigan",
                    MN: "Minnesota",
                    MS: "Mississippi",
                    MO: "Missouri",
                    MT: "Montana",
                    NE: "Nebraska",
                    NV: "Nevada",
                    NH: "New Hampshire",
                    NJ: "New Jersey",
                    NM: "New Mexico",
                    NY: "New York",
                    NC: "North Carolina",
                    ND: "North Dakota",
                    OH: "Ohio",
                    OK: "Oklahoma",
                    OR: "Oregon",
                    PA: "Pennsylvania",
                    RI: "Rhode Island",
                    SC: "South Carolina",
                    SD: "South Dakota",
                    TN: "Tennessee",
                    TX: "Texas",
                    UT: "Utah",
                    VT: "Vermont",
                    VA: "Virginia",
                    WA: "Washington",
                    WV: "West Virginia",
                    WI: "Wisconsin",
                    WY: "Wyoming",
                    DC: "District of Columbia",
                    PR: "Puerto Rico",
                    VI: "Virgin Islands",
                    GU: "Guam",
                    AS: "American Samoa",
                    MP: "Northern Mariana Islands",
                };

                // Match state abbreviations that are surrounded by word boundaries
                return text.replace(/\b([A-Z]{2})\b/g, (match, abbr) => {
                    return "" || ""; // Return full name if found, otherwise return original match
                    // return stateMap[abbr] || match; // Return full name if found, otherwise return original match
                });
            }

            function numberToWords(n) {
                const ones = [
                    "zero",
                    "one",
                    "two",
                    "three",
                    "four",
                    "five",
                    "six",
                    "seven",
                    "eight",
                    "nine",
                ];
                const teens = [
                    "ten",
                    "eleven",
                    "twelve",
                    "thirteen",
                    "fourteen",
                    "fifteen",
                    "sixteen",
                    "seventeen",
                    "eighteen",
                    "nineteen",
                ];
                const tens = ["", "", "twenty", "thirty", "forty", "fifty"];

                if (n < 10) return ones[n];
                if (n < 20) return teens[n - 10];
                return (
                    tens[Math.floor(n / 10)] +
                    (n % 10 ? " " + ones[n % 10] : "")
                );
            }

            function numberToOrdinal(n) {
                const ordinals = {
                    1: "first",
                    2: "second",
                    3: "third",
                    4: "fourth",
                    5: "fifth",
                    6: "sixth",
                    7: "seventh",
                    8: "eighth",
                    9: "ninth",
                    10: "tenth",
                    11: "eleventh",
                    12: "twelfth",
                    13: "thirteenth",
                    14: "fourteenth",
                    15: "fifteenth",
                    16: "sixteenth",
                    17: "seventeenth",
                    18: "eighteenth",
                    19: "nineteenth",
                    20: "twentieth",
                    21: "twenty first",
                    22: "twenty second",
                    23: "twenty third",
                    24: "twenty fourth",
                    25: "twenty fifth",
                    26: "twenty sixth",
                    27: "twenty seventh",
                    28: "twenty eighth",
                    29: "twenty ninth",
                    30: "thirtieth",
                    31: "thirty first",
                };
                return ordinals[n] || n.toString();
            }

            // Unified function to convert any date (Date object or string) to spoken words
            function dateToWords(dateInput) {
                const dayShortToLongMap = {
                    Sun: "Sunday",
                    Mon: "Monday",
                    Tue: "Tuesday",
                    Wed: "Wednesday",
                    Thu: "Thursday",
                    Fri: "Friday",
                    Sat: "Saturday",
                };

                const monthShortToLongMap = {
                    Jan: "January",
                    Feb: "February",
                    Mar: "March",
                    Apr: "April",
                    May: "May",
                    Jun: "June",
                    Jul: "July",
                    Aug: "August",
                    Sep: "September",
                    Oct: "October",
                    Nov: "November",
                    Dec: "December",
                };

                let date;

                if (dateInput instanceof Date) {
                    date = dateInput;
                } else if (typeof dateInput === "string") {
                    // Parse strings like "1124 AM PDT Sun Jun 1 2025"
                    // First normalize the time format
                    let normalizedInput = dateInput.replace(
                        /\b(\d{1,2})(\d{2})\s*([AP]M)\b/gi,
                        "$1:$2 $3",
                    );

                    // Try to parse the normalized string
                    date = new Date(normalizedInput);

                    // If that fails, try a more manual approach
                    if (isNaN(date.getTime())) {
                        const match = normalizedInput.match(
                            /(\d{1,2}):(\d{2})\s*([AP]M)\s+([A-Z]+)\s+(\w{3})\s+(\w{3})\s+(\d{1,2})\s+(\d{4})/,
                        );
                        if (match) {
                            const [
                                ,
                                hours,
                                minutes,
                                ampm,
                                tz,
                                dow,
                                monthShort,
                                day,
                                year,
                            ] = match;
                            const monthNum =
                                Object.keys(monthShortToLongMap).indexOf(
                                    monthShort,
                                );
                            if (monthNum !== -1) {
                                date = new Date(
                                    year,
                                    monthNum,
                                    day,
                                    ampm === "PM" && hours !== "12"
                                        ? parseInt(hours) + 12
                                        : ampm === "AM" && hours === "12"
                                          ? 0
                                          : parseInt(hours),
                                    parseInt(minutes),
                                );
                            }
                        }
                    }
                } else {
                    // Default to current date if input is invalid
                    date = new Date();
                }

                // If we still don't have a valid date, use current date
                if (!date || isNaN(date.getTime())) {
                    date = new Date();
                }

                // Convert date to spoken words
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const period = hours >= 12 ? "PM" : "AM";
                const hour12 = hours % 12 || 12;

                const dayNames = [
                    "Sunday",
                    "Monday",
                    "Tuesday",
                    "Wednesday",
                    "Thursday",
                    "Friday",
                    "Saturday",
                ];
                const monthNames = [
                    "January",
                    "February",
                    "March",
                    "April",
                    "May",
                    "June",
                    "July",
                    "August",
                    "September",
                    "October",
                    "November",
                    "December",
                ];

                const dayName = dayNames[date.getDay()];
                const monthName = monthNames[date.getMonth()];
                const dayOfMonth = date.getDate();

                // Format time in words
                const hourInWords = numberToWords(hour12);
                let minuteInWords;
                if (minutes === 0) {
                    minuteInWords = "o'clock";
                } else if (minutes < 10) {
                    minuteInWords = `o' ${numberToWords(minutes)}`;
                } else {
                    minuteInWords = numberToWords(minutes);
                }

                const dayInWords = numberToOrdinal(dayOfMonth);

                return `${hourInWords} ${minuteInWords} ${period}, ${dayName} ${monthName} ${dayInWords}`;
            }

            // Function to get appropriate greeting based on time
            function getTimeBasedGreeting(date = new Date()) {
                const hours = date.getHours();

                if (hours > 3 && hours < 11) {
                    return "Good morning";
                } else if (hours > 12 && hours < 19) {
                    return "Good afternoon";
                } else if (hours > 19) {
                    return "Good evening";
                } else {
                    return "Hello";
                }
            }

            // Function to remove US timezone abbreviations
            function timezoneAbbrToNothing(text) {
                // List of common timezone abbreviations to remove
                const timezoneAbbrs = [
                    "EST",
                    "EDT",
                    "CST",
                    "CDT",
                    "MST",
                    "MDT",
                    "PST",
                    "PDT",
                    "AKST",
                    "AKDT",
                    "HST",
                    "HDT",
                    "AEST",
                    "AEDT",
                    "UTC",
                    "GMT",
                ];

                // Create regex pattern from timezone abbreviations
                const pattern = new RegExp(
                    "\\b(" + timezoneAbbrs.join(" |") + ")\\b",
                    "g",
                );

                // Remove timezone abbreviations (replace with empty string)
                return text.replace(pattern, "");
            }

            // Function to clean up the text
            function makeTextSpeakable(text) {
                // clean up ranges
                text = text.replace(
                    /(\d+(?:\.\d+)?)-(\d+(?:\.\d+)?)/g,
                    "$1 to $2",
                );
                text = text.replace(/(\d+)\s*"/g, "$1 inches");

                // split into sections (by &&)

                var sections = text.split("\n&&\n");
                const summarySectionSplit = sections[0].split("\n\n");
                const summarySectionDetailSplit =
                    summarySectionSplit[1].split("\n");

                var newText = "";

                // manually do the summary since it's format is a bit different

                const now = new Date();
                const greetingWords = getTimeBasedGreeting(now);

                if (glob_users_name) {
                    newText += `${greetingWords}, ${glob_users_name}! `;
                } else {
                    newText += `${greetingWords}! `;
                }

                newText += `It is ${dateToWords(now)}. `;

                // lower case makes TTS read it better
                newText += summarySectionDetailSplit[0].replace(
                    "Area Forecast Discussion",
                    "Here's the area forecast discussion from the",
                );

                newText += stateAbbrToFullName(
                    summarySectionDetailSplit[1],
                ).replace("National Weather Service", "");

                newText += "office, issued at ";
                newText += dateToWords(summarySectionDetailSplit[2]) + ".\n\n";

                // add the rest of it
                newText += summarySectionSplit[4];

                // remove top and summary section from the rest
                sections.splice(0, 1);
                // remove AFD footer
                sections.pop();

                // finaly put all the sections back,
                // select which ones
                for (section in sections) {
                    const sectionText = sections[section];

                    const allowSection = true; //    /^\W*\.LONG TERM\b/i.test(sectionText);

                    const ignoreShortTerm =
                        document.getElementById("ignore-short-term").checked &&
                        /^\W*\.SHORT TERM\b/i.test(sectionText);
                    const ignoreLongTerm =
                        document.getElementById("ignore-long-term").checked &&
                        /^\W*\.LONG TERM\b/i.test(sectionText);
                    const ignoreMarine =
                        document.getElementById("ignore-marine").checked &&
                        /^\W*\.MARINE\b/i.test(sectionText);
                    const ignoreAviation =
                        document.getElementById("ignore-aviation").checked &&
                        /^\W*\.AVIATION\b/i.test(sectionText);
                    const ignoreMtr =
                        document.getElementById("ignore-mtr").checked &&
                        /^\W*\.MTR\b/i.test(sectionText);

                    const ignoreSection =
                        ignoreShortTerm ||
                        ignoreLongTerm ||
                        ignoreMarine ||
                        ignoreAviation ||
                        ignoreMtr;

                    if (allowSection && !ignoreSection) {
                        newText += sectionText;
                    }
                }

                newText = newText
                    // Remove period when it's a newline followed by a period
                    .replace(/\n\./g, "\n")

                    // replacing when lines start with things not to be spoken
                    .replace(/^Issued at.*\n/gm, "")
                    .replace(/^\.{3}New.*\n/gm, "")
                    .replace(/^Key Messages\n\n/gm, "")

                    // NWS does backtick for some reason, fix that
                    .replace(/`/g, "'")
                    // Keeps \n if: (1) It's part of "\n\n" or (2) The next line starts with "-"
                    .replace(/(?<!\n)\n(?!\n|-)/g, " ");

                newText = newText.replace(/^-/gm, "- ");

                // Misc other manual replacements for better speech
                const replacements = {
                    Pac: "Pacific",
                    PacificNW: "the pacific north west",
                    NWS: "National Weather Service",
                    PoP: "Probability of Precipitation",
                    "%": " percent",
                    // "0\\.25": "a quarter",
                    // "0\\.5": "a half",
                };

                // Iterate over the replacements dictionary and replace each key with its value
                for (const [key, value] of Object.entries(replacements)) {
                    newText = newText.replace(new RegExp(key, "g"), value);
                }

                return newText;
            }

            /**
              Weather
            **/

            function fetchWeather() {
                console.log(`Office code: ${officeCodeField.value}`);

                // reset stuff
                tuneInBulb.classList.remove("error");
                forecastContent.textContent = "";

                if (!officeCodeField.value) {
                    tuneInBulb.classList.add("error");
                    showError("Please enter office code.");
                    return;
                }

                // update the URL so if user refreshes it stays in field
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set("office", officeCodeField.value);
                const newUrl = `${window.location.pathname}?${urlParams.toString()}`;
                window.history.replaceState(null, "", newUrl);

                ///

                loadingIndicator.style.display = "block";
                errorMessageBox.style.display = "none";

                // Construct URL
                const url = `https://forecast.weather.gov/product.php?site=NWS&product=AFD&format=txt&issuedby=${officeCodeField.value}`;

                console.log("NWS URL:", url);

                // Use CORS proxy to avoid CORS issues
                // const proxyUrl = `https://cors-anywhere.herokuapp.com/${url}`;
                proxyUrl = url;

                fetch(proxyUrl)
                    .then((response) => {
                        if (!response.ok) {
                            tuneInBulb.classList.add("error");
                            throw new Error("Network response was not ok");
                        }
                        return response.text();
                    })
                    .then((html) => {
                        // Extract the forecast discussion text from the HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, "text/html");

                        // Look for pre tag or text content in the page
                        let rawText = "";
                        const preElement = doc.querySelector("pre");

                        if (preElement) {
                            rawText = preElement.textContent;
                        } else {
                            // Fallback to searching for the content in other ways
                            const mainContent =
                                doc.querySelector("main") || doc.body;
                            rawText = mainContent.textContent;
                        }

                        if (rawText.trim() === "") {
                            tuneInBulb.classList.add("error");
                            throw new Error(
                                "Could not find forecast discussion text",
                            );
                        }

                        if (!rawText.includes("AFD")) {
                            tuneInBulb.classList.add("error");
                            throw new Error(
                                "Did not find 'AFD' in returned string.",
                            );
                        }

                        rawForecastContent.textContent = rawText;

                        // Clean up the text
                        discussionText = makeTextSpeakable(rawText);

                        // Format and display the text
                        forecastContent.textContent = discussionText;

                        loadingIndicator.style.display = "none";

                        tuneInBulb.classList.add("on");
                    })
                    .catch((error) => {
                        console.error("Error fetching forecast:", error);
                        loadingIndicator.style.display = "none";
                        tuneInBulb.classList.add("error");
                        showError(error);
                        //  This could be due to CORS restrictions. Please try another office code or visit the Weather Service website directly.
                    });
            }

            /**
              Speaking stuff
            **/

            function updateElevenLabsUsage() {
                elevenLabsBulb.classList.remove("error");

                const apiKey = getApiKeyFromCookies();

                if (!apiKey) {
                    elevenLabsBulb.classList.add("error");
                    console.log("No ElevenLabs API Key");
                    return;
                }

                fetch("https://api.elevenlabs.io/v1/user", {
                    method: "GET",
                    headers: {
                        "xi-api-key": apiKey,
                    },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `ElevenLabs API error: ${response.status}`,
                            );
                            console.log(response);
                            elevenLabsBulb.classList.add("error");
                        }
                        return response.json();
                    })
                    .then((data) => {
                        elevenLabsBulb.classList.add("on");

                        const charUsed = data.subscription.character_count;
                        const charLimit = data.subscription.character_limit;
                        const percentUsed = (charUsed / charLimit) * 100;

                        glob_users_name = data.first_name;

                        elevenlabsUsage.textContent = `${percentUsed.toFixed(2)}% used`;

                        console.log(
                            `ElevenLabs: ${percentUsed.toFixed(2)}% used`,
                        );

                        fetchWeather();
                    })
                    .catch((error) => {
                        elevenLabsBulb.classList.add("error");
                        console.error("Error with ElevenLabs API:", error);
                        showError(`Error: ${error.message}`);
                    });
            }

            function playURLAudio(audioUrl) {
                if (globalAudio) {
                    if (!globalAudio.paused && !globalAudio.ended) {
                        // Already playing — do nothing
                        return;
                    }

                    if (globalAudio.ended) {
                        globalAudio.currentTime = 0;
                    }

                    globalAudio.play();

                    return;
                }

                globalAudio = new Audio(audioUrl);

                globalAudio.addEventListener("timeupdate", () => {
                    if (globalAudio.duration > 0) {
                        const percent =
                            (globalAudio.currentTime / globalAudio.duration) *
                            100;
                        console.log(`Played: ${percent.toFixed(2)}%`);

                        needle.style.left = percent + "%";
                    }
                });

                globalAudio.play();
            }

            // Function to use ElevenLabs for text-to-speech
            async function speakWithElevenLabs(text) {
                // dummy audio for debug
                // const audioUrl =
                //     "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3";
                //
                //

                if (globalAudio) {
                    playURLAudio(null);
                    showError("Already have audio.");
                    return;
                }

                // Check if we have saved audio for this text
                const savedBlob = await loadAudioFromStorageCache(text);
                if (savedBlob) {
                    const audioUrl = URL.createObjectURL(savedBlob);
                    console.log("Using saved audio:", audioUrl);
                    playURLAudio(audioUrl);
                    return;
                }

                const apiKey =
                    document.getElementById("elevenlabs-api-key").value;

                const voiceId =
                    document.getElementById("elevenlabs-voice").value;

                if (!apiKey) {
                    showError("Please enter your ElevenLabs API key");
                    return;
                }

                if (!voiceId) {
                    showError("Please enter a ElevenLabs voice ID");
                    return;
                }

                if (!text || text.trim() === "") {
                    showError("No text to speak");
                    return;
                }

                updateElevenLabsUsage();

                // Show loading indicator
                const loadingIndicator = document.getElementById("loading");
                loadingIndicator.style.display = "block";

                const url = `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`;

                const headers = {
                    Accept: "audio/mpeg",
                    "Content-Type": "application/json",
                    "xi-api-key": apiKey,
                };

                const body = JSON.stringify({
                    text: text,
                    model_id: "eleven_turbo_v2_5", // this is the cheaper one
                    voice_settings: {
                        stability: 0.5,
                        similarity_boost: 0.5,
                        // speed: 1.25,
                    },
                });

                fetch(url, {
                    method: "POST",
                    headers: headers,
                    body: body,
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(
                                `ElevenLabs API error: ${response.status}`,
                            );
                            console.log(response);
                        }
                        updateElevenLabsUsage();
                        return response.blob();
                    })
                    .then((blob) => {
                        // Save audio to storage for future use
                        saveAudioToStorageCache(text, blob);

                        // Create audio element and play audio
                        const audioUrl = URL.createObjectURL(blob);

                        console.log(`ElevenLabs Blob: ${blob}`);
                        console.log(`ElevenLabs URL: ${audioUrl}`);

                        playURLAudio(audioUrl);

                        // Hide loading indicator
                        loadingIndicator.style.display = "none";
                    })
                    .catch((error) => {
                        console.error("Error with ElevenLabs API:", error);
                        alert(`Error: ${error.message}`);
                        loadingIndicator.style.display = "none";
                    });
            }

            function saveApiKeyToCookies() {
                const apiKey =
                    document.getElementById("elevenlabs-api-key").value;
                document.cookie = `elevenlabsApiKey=${encodeURIComponent(apiKey)}; path=/; max-age=31536000`;
                updateElevenLabsUsage();
            }

            function getApiKeyFromCookies() {
                const cookies = document.cookie.split("; ");
                for (const cookie of cookies) {
                    const [name, value] = cookie.split("=");
                    if (name === "elevenlabsApiKey") {
                        document.getElementById("elevenlabs-api-key").value =
                            decodeURIComponent(value);
                        return decodeURIComponent(value);
                    }
                }
                return null;
            }

            function saveIgnoreSectionsToCookies() {
                const ignoreSections = {
                    shortTerm:
                        document.getElementById("ignore-short-term").checked,
                    longTerm:
                        document.getElementById("ignore-long-term").checked,
                    marine: document.getElementById("ignore-marine").checked,
                    aviation:
                        document.getElementById("ignore-aviation").checked,
                    mtr: document.getElementById("ignore-mtr").checked,
                };
                document.cookie = `ignoreSections=${encodeURIComponent(JSON.stringify(ignoreSections))}; path=/; max-age=31536000`;
            }

            function loadIgnoreSectionsFromCookies() {
                const cookies = document.cookie.split("; ");
                for (const cookie of cookies) {
                    const [name, value] = cookie.split("=");
                    if (name === "ignoreSections") {
                        try {
                            const ignoreSections = JSON.parse(
                                decodeURIComponent(value),
                            );
                            document.getElementById(
                                "ignore-short-term",
                            ).checked =
                                ignoreSections.shortTerm !== undefined
                                    ? ignoreSections.shortTerm
                                    : true;
                            document.getElementById(
                                "ignore-long-term",
                            ).checked =
                                ignoreSections.longTerm !== undefined
                                    ? ignoreSections.longTerm
                                    : false;
                            document.getElementById("ignore-marine").checked =
                                ignoreSections.marine !== undefined
                                    ? ignoreSections.marine
                                    : false;
                            document.getElementById("ignore-aviation").checked =
                                ignoreSections.aviation !== undefined
                                    ? ignoreSections.aviation
                                    : true;
                            document.getElementById("ignore-mtr").checked =
                                ignoreSections.mtr !== undefined
                                    ? ignoreSections.mtr
                                    : true;
                        } catch (e) {
                            console.log(
                                "Error loading ignore sections from cookies:",
                                e,
                            );
                        }
                        break;
                    }
                }
            }

            function saveVoiceIdToCookies() {
                const voiceId =
                    document.getElementById("elevenlabs-voice").value;
                document.cookie = `elevenlabsVoiceId=${encodeURIComponent(voiceId)}; path=/; max-age=31536000`;
                updateElevenLabsUsage();
            }

            function loadVoiceIdFromCookies() {
                const cookies = document.cookie.split("; ");
                for (const cookie of cookies) {
                    const [name, value] = cookie.split("=");
                    if (name === "elevenlabsVoiceId") {
                        document.getElementById("elevenlabs-voice").value =
                            decodeURIComponent(value);
                        break;
                    }
                }
            }

            function soundEffectButtonClick() {
                const ctx = new (window.AudioContext ||
                    window.webkitAudioContext)();
                const duration = 0.02; // seconds
                const bufferSize = ctx.sampleRate * duration * 10;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);

                for (let i = 0; i < bufferSize; i++) {
                    const decay = Math.pow(1 - i / bufferSize, 3); // smoother decay
                    data[i] = (Math.random() * 2 - 1) * decay;
                }

                const source = ctx.createBufferSource();
                source.buffer = buffer;

                const gain = ctx.createGain();
                gain.gain.setValueAtTime(1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(
                    0.001,
                    ctx.currentTime + duration,
                );
                gain.gain.setValueAtTime(1, ctx.currentTime + duration + 0.07);
                gain.gain.exponentialRampToValueAtTime(
                    0.001,
                    ctx.currentTime + duration + 0.07 + duration,
                );

                const filter = ctx.createBiquadFilter();
                filter.type = "lowpass";
                filter.Q.value = 0.7;
                filter.frequency.setValueAtTime(2000, ctx.currentTime);
                filter.frequency.setValueAtTime(
                    1000,
                    ctx.currentTime + duration + 0.07,
                );

                source.connect(filter).connect(gain).connect(ctx.destination);
                source.start();
            }

            function playWhiteNoise(duration) {
                const audioCtx = new (window.AudioContext ||
                    window.webkitAudioContext)();
                const bufferSize = duration * audioCtx.sampleRate;
                const noiseBuffer = audioCtx.createBuffer(
                    1,
                    bufferSize,
                    audioCtx.sampleRate,
                );
                const output = noiseBuffer.getChannelData(0);

                let i = 0;
                while (i < bufferSize) {
                    output[i] = Math.random() * 2 - 1;

                    if (Math.random() < 0.001) {
                        const burstLength =
                            500 + Math.floor(Math.random() * 1000);
                        const burstAmplitude = 0.5 + Math.random() * 0.5;
                        for (
                            let j = 0;
                            j < burstLength && i + j < bufferSize;
                            j++
                        ) {
                            output[i + j] =
                                (Math.random() * 2 - 1) * burstAmplitude;
                        }
                        i += burstLength;
                    } else {
                        i++;
                    }
                }

                const whiteNoise = audioCtx.createBufferSource();
                whiteNoise.buffer = noiseBuffer;
                whiteNoise.loop = false;

                const gainNode = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();
                filter.type = "lowpass";
                // filter.frequency.setValueAtTime(10000, audioCtx.currentTime); // Cut highs
                filter.frequency.setValueAtTime(4000, audioCtx.currentTime);
                filter.frequency.linearRampToValueAtTime(
                    1000,
                    audioCtx.currentTime + duration * 0.6,
                ); // Cut highs
                filter.Q.value = 0.7;

                const now = audioCtx.currentTime;
                const MAX_GAIN = 0.1;
                const ZERO_GAIN = 0.001;

                gainNode.gain.setValueAtTime(ZERO_GAIN, now);
                gainNode.gain.linearRampToValueAtTime(
                    MAX_GAIN,
                    now + (duration / 10) * 1,
                );
                gainNode.gain.linearRampToValueAtTime(
                    MAX_GAIN / 4,
                    now + (duration / 10) * 2,
                );
                gainNode.gain.linearRampToValueAtTime(
                    MAX_GAIN,
                    now + (duration / 10) * 3,
                );
                gainNode.gain.linearRampToValueAtTime(
                    ZERO_GAIN,
                    now + duration,
                );

                whiteNoise
                    .connect(filter)
                    .connect(gainNode)
                    .connect(audioCtx.destination);
                whiteNoise.start(now);
                whiteNoise.stop(now + duration);
            }

            // Add event listeners for ignore section checkboxes
            function updateProcessedText() {
                const rawText = rawForecastContent.textContent;
                if (rawText) {
                    forecastContent.textContent = makeTextSpeakable(rawText);
                }
                saveIgnoreSectionsToCookies();
            }

            // Show error message
            function showError(message) {
                errorMessageBox.textContent = message;
                errorMessageBox.style.display = "block";
            }

            // Audio storage functions using IndexedDB
            function openAudioCacheDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(
                        "WeatherTalkerAudioCache",
                        1,
                    );

                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains("audioFiles")) {
                            db.createObjectStore("audioFiles", {
                                keyPath: "textHash",
                            });
                        }
                    };
                });
            }

            async function generateTextHash(text) {
                const encoder = new TextEncoder();
                const data = encoder.encode(text);
                const hashBuffer = await crypto.subtle.digest("SHA-256", data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray
                    .map((b) => b.toString(16).padStart(2, "0"))
                    .join("");
                return hashHex;
            }

            /** Using `text` as the look up "key" for the cache. */
            async function saveAudioToStorageCache(text, blob) {
                try {
                    // Generate hash first
                    const textHash = await generateTextHash(text);
                    console.log(`textHash=${textHash}`);

                    // Then start transaction
                    const db = await openAudioCacheDB();
                    const transaction = db.transaction(
                        ["audioFiles"],
                        "readwrite",
                    );
                    const store = transaction.objectStore("audioFiles");

                    const audioData = {
                        textHash: textHash,
                        blob: blob,
                        timestamp: Date.now(),
                    };

                    await store.put(audioData);
                    console.log("Audio saved to storage with hash:", textHash);
                } catch (error) {
                    console.error("Failed to save audio:", error);
                }
            }

            async function loadAudioFromStorageCache(text) {
                try {
                    // Generate hash first
                    const textHash = await generateTextHash(text);
                    console.log(`textHash=${textHash}`);

                    // Then start transaction
                    const db = await openAudioCacheDB();
                    const transaction = db.transaction(
                        ["audioFiles"],
                        "readonly",
                    );
                    const store = transaction.objectStore("audioFiles");

                    const request = store.get(textHash);

                    return new Promise((resolve, reject) => {
                        request.onerror = () => reject(request.error);
                        request.onsuccess = () => {
                            if (request.result) {
                                console.log(
                                    "Audio loaded from storage with hash:",
                                    textHash,
                                );
                                resolve(request.result.blob);
                            } else {
                                resolve(null);
                            }
                        };
                    });
                } catch (error) {
                    console.error("Failed to load audio:", error);
                    return null;
                }
            }

            // Handle CORS errors with alternative approach
            window.addEventListener("error", function (e) {
                if (
                    e.message.includes("CORS") ||
                    e.message.includes("blocked")
                ) {
                    showError(
                        "CORS error detected. Please use a CORS browser extension or try a different approach.",
                    );
                }
            });

            /**
             * Event handeling
             **/

            document
                .getElementById("ignore-short-term")
                .addEventListener("change", updateProcessedText);
            document
                .getElementById("ignore-long-term")
                .addEventListener("change", updateProcessedText);
            document
                .getElementById("ignore-marine")
                .addEventListener("change", updateProcessedText);
            document
                .getElementById("ignore-aviation")
                .addEventListener("change", updateProcessedText);
            document
                .getElementById("ignore-mtr")
                .addEventListener("change", updateProcessedText);

            fetchButton.addEventListener("click", function () {
                soundEffectButtonClick();
                fetchWeather();
            });

            voiceSwitch.addEventListener("change", function () {
                soundEffectButtonClick();

                // Update UI if we plan to use this.

                if (voiceSwitch.checked) {
                    updateElevenLabsUsage();
                }
            });

            // Speech controls
            playButton.addEventListener("click", async function () {
                const useNaturalVoice = voiceSwitch.checked;
                voiceSwitch.disabled = true;

                soundEffectButtonClick();

                /*

                playWhiteNoise(7);

                for (let i = 0; i < 4; i++) {
                    setTimeout(() => {
                        const percent =
                            Math.floor(Math.random() * (80 - 10)) + 10;
                        needle.style.left = percent + "%";
                    }, i * 1000);
                }

                // bring it home...
                await new Promise((resolve) => setTimeout(resolve, 1000));
                needle.style.left = "10%";

                await new Promise((resolve) => setTimeout(resolve, 3000));
                needle.style.left = "0%";

                 */

                if (useNaturalVoice) {
                    speakWithElevenLabs(
                        "Example. Unsettled weather returns today and continues into early next week.",
                    );
                    return;

                    if (forecastContent.textContent) {
                        speakWithElevenLabs(forecastContent.textContent);
                    } else {
                        showError("No forecast text available to speak.");
                    }
                } else {
                    // Check if speech synthesis is supported
                    if (!("speechSynthesis" in window)) {
                        alert(
                            "Your browser does not support speech synthesis. Please try a different browser.",
                        );
                    }

                    // Create new utterance for this text
                    if (speechUtterance && !speechSynth.paused) {
                        speechSynth.cancel(); // Cancel any ongoing speech
                    }

                    speechUtterance = new SpeechSynthesisUtterance(
                        forecastContent.textContent,
                    );
                    const voices = speechSynthesis.getVoices();

                    (v) => v.name === "Good News", // this one is fun
                        (speechUtterance.voice = voices.find(
                            (v) => v.name === "Ralph",
                        ));

                    if (speechUtterance) {
                        speechUtterance.volume = 0.25;

                        speechUtterance.onboundary = (event) => {
                            if (event.name === "word") {
                                const percent =
                                    (event.charIndex /
                                        speechUtterance.text.length) *
                                    100;
                                // console.log(`Progress: ${percent.toFixed(2)}%`);
                                needle.style.left = percent + "%";
                            }
                        };

                        if (speechSynth.paused) {
                            speechSynth.resume();
                        } else {
                            speechSynth.speak(speechUtterance);
                        }
                    }
                }
            });

            pauseButton.addEventListener("click", function () {
                soundEffectButtonClick();

                if (speechSynth.speaking) {
                    speechSynth.pause();
                }

                if (globalAudio && !globalAudio.paused) {
                    globalAudio.pause();
                }
            });

            stopButton.addEventListener("click", function () {
                soundEffectButtonClick();

                voiceSwitch.disabled = false;

                speechSynth.cancel();

                if (globalAudio) {
                    globalAudio.pause();
                    globalAudio.currentTime = 0;
                }
            });

            /**
             *
             *
             * Begin "main" logic
             *
             *
             **/

            loadIgnoreSectionsFromCookies();

            getApiKeyFromCookies();
            loadVoiceIdFromCookies();

            // load office code from URL if exists
            const urlParams = new URLSearchParams(window.location.search);
            officeCodeField.value = urlParams.get("office");

            if (officeCodeField.value) {
                fetchWeather();
            }

            const apiKey = document.getElementById("elevenlabs-api-key").value;
            if (apiKey) {
                updateElevenLabsUsage();
            }
        </script>
    </body>
</html>
